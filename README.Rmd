
<img src="https://raw.githubusercontent.com/reconhub/reportfactory/master/artwork/workflow.png" width="100%">

<br>


[![Travis-CI Build Status](https://travis-ci.org/reconhub/reportfactory.svg?branch=master)](https://travis-ci.org/reconhub/reportfactory)
[![Build status](https://ci.appveyor.com/api/projects/status/7h2mgej230dv5r7w/branch/master?svg=true)](https://ci.appveyor.com/project/thibautjombart/reportfactory/branch/master)
[![Coverage Status](https://codecov.io/github/reconhub/reportfactory/coverage.svg?branch=master)](https://codecov.io/github/reconhub/reportfactory?branch=master)
[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/reportfactory)](https://cran.r-project.org/package=reportfactory)
[![CRAN Downloads](https://cranlogs.r-pkg.org/badges/reportfactory)](https://cran.r-project.org/package=reportfactory)


```{r, echo = FALSE, message=FALSE, results='hide'}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  fig.path = "figs/",
  echo = TRUE
)

```

# Welcome to reportfactory!

## reportfactory in a nutshell 

reportfactory is a lightweight R package which facilitates a workflow for compiling multiple `.Rmd` reports using `rmarkdown::render()` within a folder. It only requires three dependencies, making it perfect for working in environments where internet connections are unreliable. It enforces time-stamped naming conventions and newly generated outputs are stored in dedicated time-stamped folders. It provides functions for doing so to all documents, or only the most recent. 

In essence a factory is a structured folder to empower version control in projects with a need for repeated analysis over time. 

### Motivation

Some projects may require different types of analyses to be run repeatedly over
time, for instance due to updates in data and inputs. 

While `rmkardown::render` is becoming a standard for compiling a single analysis document, a number of issues remain: one needs to keep track of different version of the data/inputs, of the analysis code itself, and of different versions of the outputs.

*reportfactory* aims to facilitate these tasks by:

- defining a report as an explicitly dated `.Rmd` file
- providing functions to compile all reports, using by default the most recent
  versions
- storing each report output in a separate, time-stamped folder
- maintaining compatibility with basic workflows, i.e. all reports can still be
  directly compiled using `rmarkdown::render()` for testing purposes (although
  one should make sure to remove the outputs afterwards)
- keeping things simple: no configuration files, no handling of potential
  dependencies between reports, no caching
- git-friendly: the factory is compatible with git-based workflows, it keeps core code versioned but saves copies of outputs locally, making it lightweight, but also keeps improvements distributable. 



### Components of a factory

A report factory is a folder with the following structure (see next section for
creating new factories):

- `report_sources/`: folder storing `.Rmd` reports (possibly in sub-folders);
  files **must be** named using the convention `[report_base_name]_[yyyy-mm-dd].Rmd`; the
  date format is very important as it will be used for identifying the latest
  report version; *examples*: `sitrep_ebola_2018-06-13`,
  `incidence_curve_flu_2017-12-23`; **note** this folder should not contain any
  outputs of the `.Rmd` files!
  
- `report_outputs`: outputs of the reports, automatically generated by the
  factory, in dedicated folders named as
  `[report_base_name]_[yyyy-mm-dd]/compiled_[timestamp]/`


# `reportfactory` in practice

## Installing the package

To install the development version of the package, use:

```{r install2, eval = FALSE}
devtools::install_github("reconhub/reportfactory")
```

Note that this requires the package `devtools` installed.


## What does it do?

The main features of the package include:

- **`new_factory()`**: will create a new report factory, by default adding examples
  of reports ready for compilation

- **`list_reports()`**: will list available reports

- **`list_outputs()`**: will list available outputs

- **`list_deps()`**: will list packages needed in the reports; use the option
  `missing = TRUE` to list only packages that are missing and need to be
  installed

- **`install_deps()`**: will install packages needed in the reports; by default,
  only install missing packages; use `update = TRUE` to force the install of all
  packages

- **`validate_factory()`**: will check that the factory is valid, that all
  report names are unique, etc.

- **`compile_report()`**: compiles one specific report (name to be
  matched against the output of `list_reports()`
  
- **`update_reports()`**: compiles every report, using by default the latest
  version of each report; use the options `all = TRUE` to compile all reports
  (including old ones)


Note that manual compilation of each document can still be done the usual way,
using `rmarkdown::render` in the source folder; if you do so, make sure you
remove all output files, as they would prevent further updates from the factory.


## Suggested workflow
  
1. create a new factory using `new_factory()` and move into this new folder
   
2. go to `report_sources/`, write your `.Rmd` report, using the provided
   examples as inspiration; remove the examples files; make sure you use the
   naming conventions explained above, e.g. `foobar_2018-01-25.Rmd`.

3. check your report by compiling the `.Rmd` manually if needed,
   e.g. `rmarkdown::render("foobar_2018-01-25.Rmd")`; once you are happy with the
   results, **make sure you remove all output files from the source folder**
   
4. run `update_reports()` to generate all outputs, or
   `compile_report("foobar_2018-01-25")` if you just want to produce
   time-stamped outputs for this report; check results in the folder
   `report_outputs`
   


# Example

We start by creating a new factory in the temporary folder:

```{r creation}
library(reportfactory)

destination <- file.path(tempdir(), "new_factory") # In practise one should not use a temporary directory else all will be lost.
destination
new_factory(destination)
dir()

```

By default, examples of reports (using simulated epidemiological data) are added to the factory; these can be listed by:

```{r listing, echo = -1}
setwd(destination)
list_reports()
list_outputs()
list_deps() # list all needed packages
list_deps(missing = TRUE) # list only missing ones

list.dirs()  # Clarity - show directory
```

To compile a single report, one can use:

```{r compile_one, echo = -1}
setwd(destination)
compile_report("example_report_2019-01-31.Rmd", quiet = TRUE)
list_outputs()

list.dirs()  # Clarity - show how directory changes after compilation 
```

To compile all reports (only most recent versions), use:

```{r compile_all, echo = -1}
setwd(destination)
update_reports()
list_outputs()
```

### Referring external files in reports

In the `Rmd` reports, all file paths should be referred to using `here()`,
assuming a path from the root directory.

#### Where to put your data / how to call them?

We recommend storing all data in a `data/` folder in the root directory. When
loading your data in the reports, make sure you use `here`, e.g.:

```{r eval = FALSE}
my_data <- read.csv(here::here("data/linelist_2018-06-11.csv"))
```

#### Where to put scripts / how to call them?

The rationale is the same as for data: store your scripts in a dedicated folder
at the root of the project, e.g. `scripts/`, and source them from R using
`here`, e.g.:

```{r eval = FALSE}
source(here::here("script/custom_plot_functions.R"))
```

#### Where to put other files / how to call them?

Follow the same idea as for data and scripts, as long as you do not alter the
minimum infrastructure (`report_sources/` and other files).





<br> <br>


# Contributors (by alphabetic order):
- [Thibaut Jombart](https://github.com/thibautjombart)

See details of contributions on:
<br>
https://github.com/reconhub/reportfactory/contributors


Contributions are welcome via **pull requests**.

Please note that this project is released with a
[Contributor Code of Conduct](CONDUCT.md). By participating in this project you
agree to abide by its terms.

**Maintainer:** Thibaut Jombart (thibautjombart@gmail.com)

